---
title: "table_display_flextable_demo"
author: "Janet Young\n"
date: "`r Sys.Date()`\n"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(flextable)
library(here)
library(data.table)
library(magrittr)
```

Checking out the `flextable` package


# Summary of features I might want to use


The caption displays within my Rstudio session but not when I knit the doc or sync to github.

Table width also doesn't seem to be carried through when I knit

```{r, tab.width=10, tab.cap="hello", tab.topcaption=TRUE}
## 
## make sure the package defaults are in place 
init_flextable_defaults()
## set some of my own defaults
set_flextable_defaults(text.align = "center", 
                       font.size = 6,
                       layout = "autofit") # text.align here doesn't seem to work
my_flextable <- flextable(head(mtcars), 
                          col_keys = c("am", "carb", "gear", "mpg", "drat" ))  %>% 
    align(align = "center", part = "all") %>%
    border_inner_h(officer::fp_border(color = "lightgrey", width=0.25), part="all") %>% 
    border_inner_v(officer::fp_border(color = "lightgrey", width=0.25), part="all") %>% 
    ## above and below the header:
    border(border.top=officer::fp_border(color = "darkgrey", width=0.5), 
           border.bottom=officer::fp_border(color = "darkgrey", width=0.5), 
           part="header") %>%
    hline_bottom(border = officer::fp_border(color = "darkgrey", width=0.5), part = "body") %>% 
    ## conditional formatting
    ## add red to just the drat column, based on drat column value
    color(i=  ~ drat > 3.5, j = ~ drat , color = "red") %>% 
    ## bold every cell in the row, based on drat column value
    bold(i = ~ drat > 3.5, j = NULL, bold = TRUE) %>% 
    width(width=0.4) %>% ## width of the table in inches
    set_table_properties(layout = "autofit", width = .2) %>% 
    set_caption(caption =  as_paragraph( as_chunk("Example flextable",
                                                  props = fp_text_default() )))

my_flextable
```

Try wrapping in plot
```{r, fig.height=2, fig.width=2}
## we lose the caption
plot(my_flextable) 
```

Try a save-table-as-image cheat (see https://github.com/davidgohel/flextable/issues/532)


```{r}
temp <- save_as_image(my_flextable, 
                      path=here("Rscripts/table_display_temp_tables/temp_flextable_3.png")) 

# {#id .class width=20% height=20%}
```

![](table_display_temp_tables/temp_flextable_3.png){#id .class width=50% height=50%}


# More code examples

Code comes from the [flextable "book" website](https://ardata-fr.github.io/flextable-book/index.html).

More examples in the [flextable gallery](https://ardata.fr/en/flextable-gallery/)

Simple table display (flextable does a bit of formatting, including autofit on the columns)

```{r}
df <- airquality[ sample.int(10),]
flextable(df)
```


Fancier

```{r}
ft <- flextable(df)
ft <- add_header_row(ft,
                     colwidths = c(4, 2),
                     values = c("Air quality", "Time")
)

ft <- theme_vanilla(ft)
ft <- add_footer_lines(ft, "Daily air quality measurements in New York, May to September 1973.")
ft <- color(ft, part = "footer", color = "#666666")
ft <- set_caption(ft, caption = "New York Air Quality Measurements")
# center the header row labels
ft <- align(ft,
            i = 1, j = NULL,
            align = "center", part = "header")

ft
```

Use `set_flextable_defaults` to change the default display settings:

```{r}
set_flextable_defaults(
    font.size = 10, 
    theme_fun = theme_vanilla,
    padding = 6,
    background.color = "#EFEFEF")
flextable(df)
```

Use col_keys to select some columns

```{r}
myft <- flextable(head(mtcars), 
                  col_keys = c("am", "carb", "gear", "mpg", "drat" ))
myft
```

Formatting certain cells/columns    
- use j to specify certain column(s) by index
- can use conditional formatting

```{r}
myft <- italic(myft, j = 3)
myft <- color(myft, ~ drat > 3.5, ~ drat, color = "red")
myft <- bold(myft, ~ drat > 3.5, ~ drat, bold = TRUE)
myft
```

Adding header rows that span >1 column:

```{r}
myft <- add_header_row(
    x = myft, values = c("some measures", "other measures"),
    colwidths = c(3, 2))
myft <- align(myft, i = 1, part = "header", align = "center")
myft
```

Aligning within the parent document:

```{r}
myft <- set_table_properties(myft, align = "right", layout = "autofit")
myft
```


Ask to display non-existent columns if we want to separate groups of columns a bit - here we ask for the `col1` column.  Also `empty_blanks()` replaces <na> with blank.


```{r}
myft <- flextable(
    data = head(airquality), 
    col_keys = c("Ozone", "Solar.R", "col1", "Month", "Day")) |> 
    width(j = "col1", width = .2) |>
    empty_blanks()
myft
```

Cute table that includes tiny plots:

```{r}
## data.table seems to be similar to a data.frame, but cells can contain more complex 
z <- as.data.table(ggplot2::diamonds)

z <- z[, list(
    price = mean(price, na.rm = TRUE),
    list_col = list(.SD$x)
), by = "cut"]

# flextable ----
ft <- flextable(data = z) %>%
    mk_par(j = "list_col", value = as_paragraph(
        plot_chunk(value = list_col, type = "dens", col = "#ec11c2", 
                   width = 1.5, height = .4, free_scale = TRUE)
    )) %>%
    colformat_double(big.mark = " ", suffix = " $") %>% 
    autofit()
ft
```

Exporting formatted tables: `save_as_docx`, `save_as_pptx`, `save_as_image`

```{r}
save_as_docx(myft, path=here("Rscripts/table_display_flextable_demo_fig1.docx"))
```

Wow - you can put a these lines at the top of a doc, and then any time you print a dataframe, it will be a flextable formatted using the defaults:

```{r}
set_flextable_defaults(font.size = 11, padding = 3)
use_df_printer()
```


# Finished

```{r}
sessionInfo()
```


---
title: "trees_choosing_clades"
output: html_document
---

# Setup

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup2, include=FALSE}
library(here)
library(tidyverse)
library(janitor)
library(patchwork)
library(ggtree)
library(treeio)
library(ape)
library(dispRity)  ## for tree.age function (gets node depth)
library(phytools)
library(kableExtra)

source(here("useful_functions/phylogenetic_tree_functions.R"))
```

# Some example trees

```{r}
x <- "(((Strix_aluco:8.2,Asio_otus:4.2):3.1,Athene_noctua:7.3):6.3,Tyto_alba:13.5);"
tree.owls <- read.tree(text= x)
tree.owls <- as.treedata(tree.owls)
```


Plot tree.owls

```{r, fig.height=3, fig.width=5}
tree.owls %>% 
    ggtree() +
    geom_tiplab() +
    geom_treescale() +
    hexpand(0.3) +
    labs(title="tree.owls")
```


See what tree.owls looks like in tibble format:

```{r}
tree.owls %>% 
    as_tibble() %>% 
    kable() %>% 
    kable_styling(full_width=FALSE)
```


# Create the get_mean_dist_to_tips function 

I want a function, that for each internal node, gets the total tree length of the descendent subtree (as well as mean length per tip within the clade)

This function is are now stored in `useful_functions/phylogenetic_tree_functions.R`, but I'll show it here:

```{r}
print(get_mean_dist_to_tips)
```

Use that function on tree.owls and show the result

```{r}
my_dists <- get_mean_dist_to_tips(tree.owls)
my_dists %>% 
    kable() %>% 
    kable_styling(full_width=FALSE)
```



## Create the choose_clades function

Now we can use distance table that to choose subclades, given a certain desired distance to tip.

Here's the function:

```{r}
print(choose_clades)
```

Now I use it to choose clades, with mean distance to tip of <7 (it adds a column called `clade` to the tibble), which we can use to color the tree when we plot it:

```{r, fig.height=3, fig.width=5}
my_dists2 <- choose_clades(my_dists, dist_threshold=7)
# my_dists2 %>% 
#     kable() %>% 
#     kable_styling(full_width=FALSE)

my_dists2 %>% 
    as.treedata(branch.length, label) %>% 
    ggtree(aes(color=clade)) +
    hexpand(0.3) +
    geom_tiplab(show.legend=FALSE)
```

# Now try that on a bigger example tree

```{r, fig.height=4, fig.width=5}
nwk <- system.file("extdata", "sample.nwk", package="treeio")
tree <- read.tree(nwk) %>%  as.treedata()
tree %>% 
    ggtree() +
    geom_tiplab() +
    geom_treescale(width=10) +
    labs(title="treeio's sample.nwk tree")
```

Choose clades a couple of different ways, and show the results

```{r, fig.height=4, fig.width=10}
tree_dists <- tree %>% 
    get_mean_dist_to_tips()

tree2_tbl_1 <- tree_dists %>% 
    choose_clades(dist_threshold=10)

tree2_tbl_2 <- tree_dists %>% 
    choose_clades(dist_metric = "tot_distToTip", 
                  dist_threshold=20)

p1 <- tree2_tbl_1 %>% 
    as.treedata(branch.length, label) %>% 
    ggtree(aes(color=clade)) +
    geom_tiplab(show.legend=FALSE) +
    geom_treescale(width=10) +
    labs(title="subtree mean dist to tip < 10")
p2 <- tree2_tbl_2 %>% 
    as.treedata(branch.length, label) %>% 
    ggtree(aes(color=clade)) +
    geom_tiplab(show.legend=FALSE) +
    geom_treescale(width=10) +
    labs(title="subtree tot length <20")

(p1 + p2) +
    plot_annotation(title="treeio's sample.nwk tree")
```


We might have an idea of roughly how many clades we want to slice the tree into. We can use this function to check a few slice distances to pick a good one:


```{r}
choose_clades_several_thresholds_report(tree_dists, 
                                        distances_to_try=c(10,15,16,17,18,19,20,25,30)) %>% 
    kable(caption="Choose clades results, with several thresholds",
          digits=1) %>% 
    kable_styling(full_width=FALSE)
```
Now we see those results, we can easily choose a threshold that results in e.g. 3 clades, if that's what we want:

```{r, fig.height=4, fig.width=5}
tree_dists_three_clades <- choose_clades(tree_dists, 
                                         dist_threshold=16) 
tree_dists_three_clades %>% 
    as.treedata(branch.length, label) %>% 
    ggtree(aes(color=clade)) +
    geom_tiplab(show.legend=FALSE) +
    geom_treescale(width=10) +
    labs(title="subtree mean dist to tip < 16")
```


# Alternatives to play around with

## Try dispRity::tree.age function

This function assumes that the tree is ultrametric, which is often untrue. So I won't use it.

Age starting from present

```{r}
dispRity::tree.age(tree.owls@phylo, order = "past") %>% 
    kable() %>% 
    kable_styling(full_width=FALSE)
```

Age starting from root

```{r}
dispRity::tree.age(tree.owls@phylo, order = "present") %>% 
    kable() %>% 
    kable_styling(full_width=FALSE)
```

# Finished


```{r}
sessionInfo()
```